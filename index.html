<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>আমার এআই বন্ধু</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" xintegrity="sha512-z3gLpd7yXhW8Lq9d3e8j5Tf5tA9r1s2c/6Fm+j6V+G4k/7Qv1Cj8yv6E6S3GzGz5Sg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* ফন্ট ইম্পোর্ট */
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');

        /* কাস্টম স্টাইল */
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background: linear-gradient(135deg, #1d2b64, #f8cdda);
        }
        
        .chat-window::-webkit-scrollbar {
            width: 8px;
        }
        .chat-window::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-window::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        .loading-dots span {
            height: 10px;
            width: 10px;
            margin: 0 2px;
            background-color: #fff;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dots .dot1 { animation-delay: -0.32s; }
        .loading-dots .dot2 { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        /* বুলেট পয়েন্টের জন্য স্টাইল */
        .ai-message ul {
            list-style-type: disc;
            padding-left: 2em;
            margin-top: 0.5em;
        }
        .ai-message ol {
            list-style-type: decimal;
            padding-left: 2em;
            margin-top: 0.5em;
        }
        .ai-message li {
            margin-bottom: 0.5em;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Login Container -->
    <div id="login-container" class="flex flex-col items-center justify-center text-center p-8 bg-white bg-opacity-20 rounded-3xl shadow-xl backdrop-blur-lg transition-all duration-500 w-full max-w-sm">
        <h1 class="text-3xl font-bold text-white mb-4">স্বাগতম!</h1>
        <p class="text-white text-lg mb-6">চ্যাট শুরু করতে Google দিয়ে লগইন করুন।</p>
        <button id="google-login-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 flex items-center gap-2">
            <i class="fab fa-google"></i>
            <span>Google দিয়ে লগইন করুন</span>
        </button>
    </div>

    <!-- Main Chat Container (Hidden by default) -->
    <div id="chat-container" class="hidden w-full max-w-3xl h-[90vh] max-h-[800px] bg-white bg-opacity-20 rounded-3xl shadow-xl backdrop-blur-lg flex flex-col overflow-hidden transition-all duration-500">
        <!-- Header with User Info and Logout -->
        <div class="p-5 bg-white bg-opacity-30 border-b border-white border-opacity-30 flex justify-between items-center rounded-t-3xl">
            <div class="flex items-center gap-3">
                <img id="user-photo" src="" alt="User Photo" class="w-10 h-10 rounded-full shadow-md">
                <div>
                    <h1 class="text-lg font-bold text-gray-800" id="user-name"></h1>
                    <p class="text-sm text-gray-600">Gemini Flash দ্বারা চালিত</p>
                </div>
            </div>
            <button id="logout-btn" class="text-gray-600 hover:text-red-500 transition-colors duration-300">
                <i class="fas fa-sign-out-alt text-2xl"></i>
            </button>
        </div>

        <!-- Chat Window -->
        <div id="chat-window" class="chat-window flex-grow p-5 overflow-y-auto flex flex-col gap-4 scroll-smooth">
            <!-- Messages will be injected here -->
        </div>

        <!-- Input Area -->
        <div class="input-area flex items-center p-4 bg-white bg-opacity-30 border-t border-white border-opacity-30 gap-3">
            <input type="text" id="userInput" placeholder="আপনার প্রশ্ন এখানে লিখুন..." autocomplete="off"
                   class="flex-grow p-4 rounded-full border border-gray-300 bg-white bg-opacity-80 text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-300 placeholder:text-gray-500">
            <button id="sendButton" title="পাঠান"
                    class="w-12 h-12 bg-indigo-600 text-white rounded-full flex items-center justify-center text-2xl shadow-lg hover:bg-indigo-700 transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
    
    <script>
        // DOM Element
        const loginContainer = document.getElementById('login-container');
        const chatContainer = document.getElementById('chat-container');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const userNameEl = document.getElementById('user-name');
        const userPhotoEl = document.getElementById('user-photo');
        
        let db;
        let auth;
        let currentUser;
        let chatHistory = [];
        let unsubscribeFromFirestore;

        // আপনার দেওয়া Firebase কনফিগারেশন
        const firebaseConfig = {
          apiKey: "AIzaSyCTvWKR6pt8HrHoiDHo3wqoSXtXdXJjHHQ",
          authDomain: "priya-ai-q14sj.firebaseapp.com",
          projectId: "priya-ai-q14sj",
          storageBucket: "priya-ai-q14sj.firebasestorage.app",
          messagingSenderId: "113852032496",
          appId: "1:113852032496:web:a6156f264323f54d9ae935"
        };

        // Firebase শুরু করা
        const app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();

        // Gemini API Key
        const geminiApiKey = "AIzaSyA0TeD-ctQp9d7EhX0ZpQcamNp02_5O6tw";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

        // Google লগইন ফাংশন
        const googleLogin = async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error("Google লগইন ব্যর্থ হয়েছে:", error);
                showErrorMessage('লগইন করতে সমস্যা হয়েছে। আবার চেষ্টা করুন।');
            }
        };

        // লগআউট ফাংশন
        const logout = async () => {
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
            }
            await auth.signOut();
        };

        // ব্যবহারকারী লগইন অবস্থা পর্যবেক্ষণ
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loginContainer.classList.add('hidden');
                chatContainer.classList.remove('hidden');
                userNameEl.textContent = user.displayName;
                userPhotoEl.src = user.photoURL || 'https://placehold.co/40x40/f1f1f1/333?text=user';
                loadChatHistory(user.uid);
            } else {
                currentUser = null;
                loginContainer.classList.remove('hidden');
                chatContainer.classList.add('hidden');
            }
        });

        // চ্যাট হিস্টরি লোড করা এবং রিয়েল-টাইম আপডেট শোনা
        const loadChatHistory = (userId) => {
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore();
            }

            const messagesRef = db.collection(`artifacts/${firebaseConfig.appId}/users/${userId}/messages`);
            const q = messagesRef.orderBy("timestamp", "asc");

            unsubscribeFromFirestore = q.onSnapshot(querySnapshot => {
                chatWindow.innerHTML = ''; // উইন্ডো খালি করা
                chatHistory = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    appendMessage(data.text, data.sender, false);
                    chatHistory.push({ role: data.sender === 'user' ? 'user' : 'model', parts: [{ text: data.text }] });
                });
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }, error => {
                console.error("Firestore ডেটা লোড করতে সমস্যা হয়েছে:", error);
                showErrorMessage('চ্যাটের ইতিহাস লোড করা যায়নি।');
            });
        };

        // মেসেজ পাঠানোর ফাংশন
        const sendMessage = async () => {
            const userText = userInput.value.trim();
            if (userText === '' || !currentUser) return;

            const userMessageData = {
                text: userText,
                sender: 'user',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userEmail: currentUser.email,
                userName: currentUser.displayName
            };

            await addMessageToFirestore(userMessageData);
            
            userInput.value = '';
            appendLoadingIndicator();
            
            try {
                chatHistory.push({ role: "user", parts: [{ text: userText }] });

                const payload = { contents: chatHistory };
                const response = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                removeLoadingIndicator();

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    const aiMessageData = {
                        text: aiText,
                        sender: 'model',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await addMessageToFirestore(aiMessageData);
                    chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                } else {
                    showErrorMessage('দুঃখিত, এই প্রশ্নের উত্তর দেওয়া সম্ভব হচ্ছে না। অন্য কিছু চেষ্টা করুন।');
                    chatHistory.pop();
                }
            } catch (error) {
                console.error('AI Response পেতে সমস্যা হয়েছে:', error);
                removeLoadingIndicator();
                showErrorMessage(`দুঃখিত, একটি সমস্যা হয়েছে। অনুগ্রহ করে ইন্টারনেট সংযোগ পরীক্ষা করুন। <br><small>Error: ${error.message}</small>`);
            }
        };

        // Firestore-এ মেসেজ যুক্ত করা
        const addMessageToFirestore = async (messageData) => {
            if (!currentUser) return;
            try {
                const messagesRef = db.collection(`artifacts/${firebaseConfig.appId}/users/${currentUser.uid}/messages`);
                await messagesRef.add(messageData);
            } catch (error) {
                console.error("Firestore-এ মেসেজ যুক্ত করতে সমস্যা হয়েছে:", error);
                showErrorMessage('মেসেজ সংরক্ষণ করা যায়নি।');
            }
        };

        // Exponential Backoff retry mechanism
        const fetchWithRetry = async (url, options, retries = 3, delay = 1000) => {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    console.error(`Fetch failed, retrying in ${delay}ms...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        };

        // চ্যাট উইন্ডোতে মেসেজ যুক্ত করার ফাংশন
        const appendMessage = (text, sender, isNewMessage = true) => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', 'p-4', 'rounded-3xl', 'max-w-[85%]', 'shadow-lg', 'transition-all', 'duration-300', 'transform', 'hover:scale-105');
            
            let messageContent = text;
            if (sender === 'user') {
                messageDiv.classList.add('self-end', 'bg-indigo-600', 'text-white', 'rounded-br-lg');
            } else {
                messageDiv.classList.add('self-start', 'bg-white', 'text-gray-800', 'rounded-bl-lg', 'flex', 'flex-col', 'items-start', 'gap-2');
                const avatarDiv = document.createElement('div');
                avatarDiv.classList.add('flex', 'items-center', 'gap-2', 'mb-2');
                avatarDiv.innerHTML = `<span class="text-2xl text-indigo-500">🤖</span><span class="font-semibold">এআই বন্ধু</span>`;
                messageDiv.appendChild(avatarDiv);

                // সুন্দর করে রিপ্লাই সাজানো
                messageContent = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                messageContent = messageContent.replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italic
                messageContent = messageContent.replace(/^- (.*)$/gm, '<li class="flex items-center gap-2"><i class="fas fa-check-circle text-green-500"></i><span>$1</span></li>');
                messageContent = `<ul>${messageContent}</ul>`;
                
                // নতুন লাইনের জন্য <br>
                messageContent = messageContent.replace(/\n/g, '<br>');
                messageContent = messageContent.replace(/<\/ul><br>/g, '</ul>'); // বুলেটের পর অতিরিক্ত <br> সরানো
            }

            const textDiv = document.createElement('div');
            textDiv.innerHTML = messageContent;
            messageDiv.appendChild(textDiv);
            chatWindow.appendChild(messageDiv);

            if (isNewMessage) {
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        };
        
        // লোডিং অ্যানিমেশন দেখানোর ফাংশন
        const appendLoadingIndicator = () => {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.classList.add('message', 'self-start', 'bg-white', 'text-gray-800', 'p-4', 'rounded-3xl', 'rounded-bl-lg', 'max-w-[85%]', 'shadow-lg', 'flex', 'items-center', 'gap-2');
            loadingDiv.innerHTML = `<span class="text-2xl text-indigo-500">🤖</span><div class="loading-dots"><span class="dot1"></span><span class="dot2"></span><span class="dot3"></span></div>`;
            chatWindow.appendChild(loadingDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            sendButton.disabled = true;
            userInput.disabled = true;
        };

        // লোডিং অ্যানিমেশন সরানোর ফাংশন
        const removeLoadingIndicator = () => {
            const indicator = document.getElementById('loading-indicator');
            if (indicator) indicator.remove();
            sendButton.disabled = false;
            userInput.disabled = false;
            userInput.focus();
        };

        // ইউআই-তে ত্রুটি বার্তা দেখানো
        const showErrorMessage = (message) => {
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('message', 'self-start', 'bg-red-500', 'text-white', 'p-3', 'rounded-2xl', 'rounded-bl-none', 'max-w-[85%]', 'shadow-md');
            errorDiv.innerHTML = `<span class="text-2xl mr-2">❌</span>${message}`;
            chatWindow.appendChild(errorDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        // ইভেন্ট লিসেনার
        googleLoginBtn.addEventListener('click', googleLogin);
        logoutBtn.addEventListener('click', logout);
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });

    </script>
</body>
</html>
