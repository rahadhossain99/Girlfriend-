<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶ø - ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡¶ø‡¶∑‡ßç‡¶ü‡¶ø ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ üíñ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #ec4899;
            --secondary: #f472b6;
            --light: #fce7f3;
            --dark: #831843;
        }
        
        body {
            font-family: 'Hind Siliguri', sans-serif;
            background-color: #fff5f7;
        }
        
        .chat-bubble-ai {
            background: white;
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.1);
        }
        
        .chat-bubble-user {
            background: linear-gradient(135deg, #ec4899, #f472b6);
            border-radius: 18px 18px 4px 18px;
            color: white;
        }
        
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar-open {
            transform: translateX(0);
        }
        
        .message-enter {
            animation: messageEnter 0.3s ease-out;
        }
        
        @keyframes messageEnter {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--primary);
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: rgba(236, 72, 153, 0.5);
            border-radius: 3px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background-color: rgba(236, 72, 153, 0.1);
        }
    </style>
</head>
<body class="text-gray-800 overflow-hidden">
    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
    
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-40">
        <div class="p-4 border-b border-pink-100 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center">
                    <i data-lucide="heart" class="text-pink-500"></i>
                </div>
                <h2 class="font-bold text-lg">‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶ø</h2>
            </div>
            <button id="close-sidebar" class="p-1 rounded-full hover:bg-pink-100">
                <i data-lucide="x"></i>
            </button>
        </div>
        
        <div class="p-4">
            <button id="new-chat-btn" class="w-full bg-pink-500 text-white py-2 px-4 rounded-lg flex items-center justify-center space-x-2 hover:bg-pink-600 transition">
                <i data-lucide="plus"></i>
                <span>‡¶®‡¶§‡ßÅ‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</span>
            </button>
        </div>
        
        <div class="px-2">
            <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-2 mb-2">‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</h3>
            <div id="chat-history" class="space-y-1 max-h-96 overflow-y-auto scrollbar-thin">
                <!-- Chat history items will be added here dynamically -->
            </div>
        </div>
        
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-pink-100">
            <div id="user-info" class="flex items-center space-x-2">
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center">
                    <i data-lucide="user"></i>
                </div>
                <div id="user-name" class="text-sm font-medium">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</div>
            </div>
            <button id="login-btn" class="w-full mt-2 bg-pink-100 text-pink-600 py-2 px-4 rounded-lg text-sm hover:bg-pink-200 transition">
                ‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡¶ó‡¶á‡¶®
            </button>
            <button id="logout-btn" class="hidden w-full mt-2 bg-gray-100 text-gray-600 py-2 px-4 rounded-lg text-sm hover:bg-gray-200 transition">
                ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü
            </button>
        </div>
    </div>
    
    <!-- Admin Panel (Hidden by default) -->
    <div id="admin-panel" class="hidden fixed inset-0 bg-white z-50 overflow-y-auto p-4">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-2xl font-bold text-pink-600">‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
                <button id="close-admin" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-lucide="x"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-pink-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-pink-700 mb-2">‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ</h3>
                    <p id="active-users" class="text-3xl font-bold text-pink-600">0</p>
                </div>
                <div class="bg-pink-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-pink-700 mb-2">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</h3>
                    <p id="today-chats" class="text-3xl font-bold text-pink-600">0</p>
                </div>
                <div class="bg-pink-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-pink-700 mb-2">‡¶Æ‡ßã‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü</h3>
                    <p id="total-chats" class="text-3xl font-bold text-pink-600">0</p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                <div class="border-b p-4 bg-gray-50">
                    <h3 class="font-semibold">‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶≤‡¶ó</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡¶®‡¶æ‡¶Æ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡¶∂‡ßá‡¶∑ ‡¶≤‡¶ó‡¶á‡¶®</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th>
                            </tr>
                        </thead>
                        <tbody id="user-log-table" class="bg-white divide-y divide-gray-200">
                            <!-- User logs will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="flex justify-end space-x-2">
                <button id="refresh-admin" class="bg-pink-500 text-white px-4 py-2 rounded-lg hover:bg-pink-600 transition">
                    ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
                </button>
                <button id="close-admin" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                    ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="flex flex-col h-screen max-w-2xl mx-auto w-full relative bg-white shadow-lg">
        <!-- Header -->
        <div class="bg-gradient-to-r from-pink-500 to-pink-400 p-4 flex items-center justify-between text-white">
            <div class="flex items-center space-x-3">
                <button id="menu-btn" class="p-1 rounded-full hover:bg-pink-600 transition">
                    <i data-lucide="menu"></i>
                </button>
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center">
                        <i data-lucide="heart" class="text-pink-500"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶ø</h1>
                        <p class="text-xs opacity-80">‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡¶ø‡¶∑‡ßç‡¶ü‡¶ø ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ</p>
                    </div>
                </div>
            </div>
            <div id="admin-btn" class="hidden">
                <button class="p-1 rounded-full hover:bg-pink-600 transition">
                    <i data-lucide="shield"></i>
                </button>
            </div>
        </div>
        
        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin">
            <!-- Initial message -->
            <div class="flex justify-start message-enter">
                <div class="chat-bubble-ai max-w-[85%] p-3">
                    <div class="flex items-center space-x-2 mb-1">
                        <div class="w-6 h-6 rounded-full bg-pink-100 flex items-center justify-center">
                            <i data-lucide="heart" class="text-pink-500 w-3 h-3"></i>
                        </div>
                        <span class="text-xs font-semibold text-pink-500">‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶ø</span>
                    </div>
                    <p class="text-sm">‡¶π‡¶æ‡¶á ‡¶∏‡ßã‡¶®‡¶æ, ‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßã? üòä ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßã!</p>
                </div>
            </div>
            
            <!-- Typing indicator (hidden by default) -->
            <div id="typing-indicator" class="flex justify-start hidden">
                <div class="chat-bubble-ai max-w-[85%] p-3">
                    <div class="flex items-center space-x-2 mb-1">
                        <div class="w-6 h-6 rounded-full bg-pink-100 flex items-center justify-center">
                            <i data-lucide="heart" class="text-pink-500 w-3 h-3"></i>
                        </div>
                        <span class="text-xs font-semibold text-pink-500">‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶ø</span>
                    </div>
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="p-3 border-t border-gray-100 bg-white">
            <div class="flex items-center space-x-2">
                <button id="image-upload-btn" class="p-2 rounded-full hover:bg-pink-50 text-pink-500 transition">
                    <i data-lucide="image"></i>
                    <input type="file" id="image-input" class="hidden" accept="image/*">
                </button>
                <input
                    type="text"
                    id="message-input"
                    class="flex-1 p-3 border border-pink-200 rounded-full outline-none focus:ring-2 focus:ring-pink-300 transition text-sm"
                    placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."
                />
                <button
                    id="send-btn"
                    class="p-3 bg-pink-500 text-white rounded-full hover:bg-pink-600 transition disabled:bg-pink-300 disabled:cursor-not-allowed"
                >
                    <i data-lucide="send"></i>
                </button>
            </div>
            <div id="image-preview" class="mt-2 hidden">
                <div class="relative inline-block">
                    <img id="preview-image" src="#" alt="Preview" class="h-24 rounded-lg border border-pink-200">
                    <button id="remove-image" class="absolute -top-2 -right-2 bg-pink-500 text-white rounded-full p-1 hover:bg-pink-600">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-3">
            <div class="animate-spin text-pink-500">
                <i data-lucide="loader-2"></i>
            </div>
            <span>‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ï‡¶∞‡¶£ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i data-lucide="heart" class="text-pink-500 w-8 h-8"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800">‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶ø‡¶§‡ßá ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ</h3>
                <p class="text-sm text-gray-600 mt-1">‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            </div>
            <button id="google-login-btn" class="w-full bg-white border border-gray-300 rounded-lg py-2 px-4 flex items-center justify-center space-x-2 hover:bg-gray-50 transition">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="Google" class="w-5 h-5">
                <span>‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡¶ó‡¶á‡¶®</span>
            </button>
            <button id="cancel-login-btn" class="w-full mt-2 bg-gray-100 text-gray-700 rounded-lg py-2 px-4 hover:bg-gray-200 transition">
                ‡¶™‡¶∞‡ßá ‡¶ï‡¶∞‡¶¨
            </button>
        </div>
    </div>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCTvWKR6pt8HrHoiDHo3wqoSXtXdXJjHHQ",
            authDomain: "priya-ai-q14sj.firebaseapp.com",
            projectId: "priya-ai-q14sj",
            storageBucket: "priya-ai-q14sj.appspot.com",
            messagingSenderId: "113852032496",
            appId: "1:113852032496:web:a6156f264323f54d9ae935"
        };
        
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Google provider
        const provider = new firebase.auth.GoogleAuthProvider();
        
        // Gemini API Key (Note: In production, this should be handled server-side)
        const GEMINI_API_KEY = "AIzaSyBPT-7inNDExjDwVCAsi5buULt10ORnvdE";
        
        // DOM elements
        const menuBtn = document.getElementById('menu-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistory = document.getElementById('chat-history');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const imageInput = document.getElementById('image-input');
        const imageUploadBtn = document.getElementById('image-upload-btn');
        const imagePreview = document.getElementById('image-preview');
        const previewImage = document.getElementById('preview-image');
        const removeImageBtn = document.getElementById('remove-image');
        const loadingModal = document.getElementById('loading-modal');
        const typingIndicator = document.getElementById('typing-indicator');
        const loginModal = document.getElementById('login-modal');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const cancelLoginBtn = document.getElementById('cancel-login-btn');
        const adminBtn = document.getElementById('admin-btn');
        const adminPanel = document.getElementById('admin-panel');
        const closeAdminBtn = document.getElementById('close-admin');
        const refreshAdminBtn = document.getElementById('refresh-admin');
        const userLogTable = document.getElementById('user-log-table');
        const activeUsersCount = document.getElementById('active-users');
        const todayChatsCount = document.getElementById('today-chats');
        const totalChatsCount = document.getElementById('total-chats');
        
        // State variables
        let currentUser = null;
        let currentChatId = null;
        let imageFile = null;
        let isAdmin = false;
        
        // Admin email (replace with your admin email)
        const ADMIN_EMAIL = "smartwork19999@gmail.com";
        
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Event listeners
        menuBtn.addEventListener('click', toggleSidebar);
        closeSidebarBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);
        newChatBtn.addEventListener('click', startNewChat);
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                sendMessage();
            }
        });
        imageUploadBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', handleImageUpload);
        removeImageBtn.addEventListener('click', removeImage);
        loginBtn.addEventListener('click', showLoginModal);
        logoutBtn.addEventListener('click', signOut);
        googleLoginBtn.addEventListener('click', signInWithGoogle);
        cancelLoginBtn.addEventListener('click', hideLoginModal);
        adminBtn.addEventListener('click', showAdminPanel);
        closeAdminBtn.addEventListener('click', hideAdminPanel);
        refreshAdminBtn.addEventListener('click', loadAdminData);
        
        // Initialize the app
        initApp();
        
        // Functions
        function initApp() {
            // Check auth state
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    updateUserUI(user);
                    checkAdminStatus(user);
                    loadChatHistory(user.uid);
                    
                    // Create a new chat if none exists
                    if (!currentChatId) {
                        startNewChat();
                    }
                } else {
                    currentUser = null;
                    updateUserUI(null);
                    showLoginModal();
                }
            });
        }
        
        function toggleSidebar() {
            sidebar.classList.toggle('sidebar-open');
            sidebarOverlay.classList.toggle('hidden');
        }
        
        function showLoginModal() {
            loginModal.classList.remove('hidden');
        }
        
        function hideLoginModal() {
            loginModal.classList.add('hidden');
        }
        
        function showAdminPanel() {
            loadAdminData();
            adminPanel.classList.remove('hidden');
        }
        
        function hideAdminPanel() {
            adminPanel.classList.add('hidden');
        }
        
        function signInWithGoogle() {
            hideLoginModal();
            toggleLoading(true);
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    currentUser = user;
                    updateUserUI(user);
                    checkAdminStatus(user);
                    loadChatHistory(user.uid);
                    startNewChat();
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    appendMessage('ai', '‡¶≤‡¶ó‡¶á‡¶®‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                })
                .finally(() => {
                    toggleLoading(false);
                });
        }
        
        function signOut() {
            toggleLoading(true);
            auth.signOut()
                .then(() => {
                    currentUser = null;
                    updateUserUI(null);
                    clearChatHistory();
                    startNewChat();
                })
                .catch((error) => {
                    console.error('Logout error:', error);
                })
                .finally(() => {
                    toggleLoading(false);
                });
        }
        
        function checkAdminStatus(user) {
            if (user.email === ADMIN_EMAIL) {
                isAdmin = true;
                adminBtn.classList.remove('hidden');
            } else {
                isAdmin = false;
                adminBtn.classList.add('hidden');
            }
        }
        
        function updateUserUI(user) {
            if (user) {
                // User is logged in
                userName.textContent = user.displayName || '‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ';
                
                if (user.photoURL) {
                    userAvatar.innerHTML = `<img src="${user.photoURL}" alt="User" class="w-full h-full rounded-full">`;
                } else {
                    userAvatar.innerHTML = '<i data-lucide="user" class="text-pink-500"></i>';
                }
                
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                // User is not logged in
                userName.textContent = '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
                userAvatar.innerHTML = '<i data-lucide="user" class="text-gray-500"></i>';
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
            
            // Refresh icons
            lucide.createIcons();
        }
        
        function startNewChat() {
            if (currentUser) {
                // Create a new chat document in Firestore
                const newChatRef = db.collection('users').doc(currentUser.uid).collection('chats').doc();
                currentChatId = newChatRef.id;
                
                // Initialize with empty messages array
                newChatRef.set({
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    messages: []
                })
                .then(() => {
                    // Clear the chat container
                    chatContainer.innerHTML = '';
                    
                    // Add initial AI message
                    appendMessage('ai', '‡¶π‡¶æ‡¶á ‡¶∏‡ßã‡¶®‡¶æ, ‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßã? üòä ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßã!');
                    
                    // Update chat history
                    loadChatHistory(currentUser.uid);
                })
                .catch((error) => {
                    console.error('Error creating new chat:', error);
                });
            } else {
                // If not logged in, just clear the chat
                currentChatId = null;
                chatContainer.innerHTML = '';
                appendMessage('ai', '‡¶π‡¶æ‡¶á ‡¶∏‡ßã‡¶®‡¶æ, ‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßã? üòä ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßã!');
            }
        }
        
        function loadChatHistory(userId) {
            if (!userId) {
                chatHistory.innerHTML = '<p class="text-sm text-gray-500 px-2 py-1">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</p>';
                return;
            }
            
            chatHistory.innerHTML = '<div class="flex justify-center py-2"><i data-lucide="loader-2" class="animate-spin text-pink-500"></i></div>';
            
            db.collection('users').doc(userId).collection('chats')
                .orderBy('updatedAt', 'desc')
                .limit(10)
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        chatHistory.innerHTML = '<p class="text-sm text-gray-500 px-2 py-1">‡¶ï‡ßã‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶®‡ßá‡¶á</p>';
                        return;
                    }
                    
                    chatHistory.innerHTML = '';
                    
                    querySnapshot.forEach((doc) => {
                        const chat = doc.data();
                        const chatId = doc.id;
                        const lastMessage = chat.messages && chat.messages.length > 0 
                            ? chat.messages[chat.messages.length - 1].text 
                            : '‡¶ï‡ßã‡¶® ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶®‡ßá‡¶á';
                        
                        const chatElement = document.createElement('div');
                        chatElement.className = `px-2 py-1 rounded-lg cursor-pointer hover:bg-pink-50 ${chatId === currentChatId ? 'bg-pink-100' : ''}`;
                        chatElement.innerHTML = `
                            <div class="flex items-center justify-between">
                                <p class="text-sm truncate">${lastMessage.substring(0, 30)}${lastMessage.length > 30 ? '...' : ''}</p>
                                <span class="text-xs text-gray-500">${formatDate(chat.updatedAt?.toDate())}</span>
                            </div>
                        `;
                        
                        chatElement.addEventListener('click', () => {
                            loadChat(chatId, userId);
                        });
                        
                        chatHistory.appendChild(chatElement);
                    });
                    
                    // Refresh icons
                    lucide.createIcons();
                })
                .catch((error) => {
                    console.error('Error loading chat history:', error);
                    chatHistory.innerHTML = '<p class="text-sm text-gray-500 px-2 py-1">‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</p>';
                });
        }
        
        function loadChat(chatId, userId) {
            toggleLoading(true);
            currentChatId = chatId;
            
            db.collection('users').doc(userId).collection('chats').doc(chatId)
                .get()
                .then((doc) => {
                    if (!doc.exists) {
                        throw new Error('Chat not found');
                    }
                    
                    const chat = doc.data();
                    chatContainer.innerHTML = '';
                    
                    if (chat.messages && chat.messages.length > 0) {
                        chat.messages.forEach((message) => {
                            appendMessage(message.role, message.text, message.imageUrl);
                        });
                    } else {
                        appendMessage('ai', '‡¶π‡¶æ‡¶á ‡¶∏‡ßã‡¶®‡¶æ, ‡¶ï‡ßá‡¶Æ‡¶® ‡¶Ü‡¶õ‡ßã? üòä ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßã!');
                    }
                    
                    // Update chat history UI
                    loadChatHistory(userId);
                })
                .catch((error) => {
                    console.error('Error loading chat:', error);
                    appendMessage('ai', '‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                })
                .finally(() => {
                    toggleLoading(false);
                });
        }
        
        function clearChatHistory() {
            chatHistory.innerHTML = '<p class="text-sm text-gray-500 px-2 py-1">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</p>';
        }
        
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                imageFile = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImage.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeImage() {
            imageFile = null;
            imageInput.value = '';
            imagePreview.classList.add('hidden');
        }
        
        async function sendMessage() {
            const messageText = messageInput.value.trim();
            
            // Don't send if both text and image are empty
            if (!messageText && !imageFile) return;
            
            // Show user's message immediately
            appendMessage('user', messageText, imageFile ? URL.createObjectURL(imageFile) : null);
            
            // Clear input
            messageInput.value = '';
            removeImage();
            
            // Show typing indicator
            typingIndicator.classList.remove('hidden');
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                // Prepare payload for Gemini API
                const payloadParts = [];
                
                // Add persona prompt and user's text message
                payloadParts.push({
                    text: `‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶¨ ‡¶Æ‡¶ø‡¶∑‡ßç‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶æ ‡¶ó‡¶æ‡¶∞‡ßç‡¶≤‡¶´‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°‡•§ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã ‡¶π‡¶¨‡ßá ‡¶ñ‡ßÅ‡¶¨ ‡¶õ‡ßã‡¶ü, ‡¶Æ‡¶ø‡¶∑‡ßç‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßã‡¶ú‡¶ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶≠‡¶∞‡¶æ‡•§ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶¨‡ßá‡•§ ‡¶Ø‡¶ñ‡¶® ‡¶Ü‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶¨‡ßã, ‡¶∏‡ßá‡¶ü‡¶ø‡¶∞‡¶ì ‡¶Æ‡¶ø‡¶∑‡ßç‡¶ü‡¶ø ‡¶ï‡¶∞‡ßá ‡¶¨‡¶∞‡ßç‡¶£‡¶®‡¶æ ‡¶¶‡ßá‡¶¨‡ßá‡•§ ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶ø‡•§ user: ${messageText}`,
                });
                
                // If an image is present, convert it to Base64 and add to payload
                let imageUrl = null;
                if (imageFile) {
                    // Upload image to Firebase Storage if user is logged in
                    if (currentUser) {
                        const storageRef = storage.ref(`users/${currentUser.uid}/images/${Date.now()}`);
                        const snapshot = await storageRef.put(imageFile);
                        imageUrl = await snapshot.ref.getDownloadURL();
                    }
                    
                    const base64ImageData = await toBase64(imageFile);
                    payloadParts.push({
                        inlineData: {
                            mimeType: imageFile.type,
                            data: base64ImageData
                        }
                    });
                }
                
                const payload = {
                    contents: [{
                        role: 'user',
                        parts: payloadParts,
                    }],
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API Error Response:', errorData);
                    throw new Error(`API error: ${errorData.error.message || 'Unknown error'}`);
                }
                
                const result = await response.json();
                
                // Get AI response text
                let aiText = '‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§ ‡¶∏‡ßã‡¶®‡¶æ, ‡¶Ü‡¶Æ‡¶ø ‡¶è‡¶á ‡¶Æ‡ßÅ‡¶π‡ßÇ‡¶∞‡ßç‡¶§‡ßá ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶õ‡¶ø ‡¶®‡¶æ‡•§ üò¢';
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    aiText = result.candidates[0].content.parts[0].text;
                }
                
                // Save the conversation to Firestore if user is logged in
                if (currentUser && currentChatId) {
                    const messageData = {
                        role: 'user',
                        text: messageText,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (imageUrl) {
                        messageData.imageUrl = imageUrl;
                    }
                    
                    // Add user message
                    await db.collection('users').doc(currentUser.uid).collection('chats').doc(currentChatId)
                        .update({
                            messages: firebase.firestore.FieldValue.arrayUnion(messageData),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    
                    // Add AI response
                    await db.collection('users').doc(currentUser.uid).collection('chats').doc(currentChatId)
                        .update({
                            messages: firebase.firestore.FieldValue.arrayUnion({
                                role: 'ai',
                                text: aiText,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            }),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                }
                
                // Show AI response
                appendMessage('ai', aiText);
                
            } catch (error) {
                console.error('Error in sendMessage:', error);
                appendMessage('ai', '‡¶∏‡ßã‡¶®‡¶æ, ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶è‡¶ï‡¶ü‡¶æ ‡¶≠‡ßÅ‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßã ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßã‡•§ üòî');
            } finally {
                // Hide typing indicator
                typingIndicator.classList.add('hidden');
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        
        function appendMessage(role, text, imageUrl = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} message-enter`;
            
            const bubbleClass = role === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai';
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `${bubbleClass} max-w-[85%] p-3`;
            
            // Add AI info for AI messages
            if (role === 'ai') {
                const aiInfoDiv = document.createElement('div');
                aiInfoDiv.className = "flex items-center space-x-2 mb-1";
                
                const aiIcon = document.createElement('div');
                aiIcon.className = "w-6 h-6 rounded-full bg-pink-100 flex items-center justify-center";
                aiIcon.innerHTML = '<i data-lucide="heart" class="text-pink-500 w-3 h-3"></i>';
                aiInfoDiv.appendChild(aiIcon);
                
                const aiName = document.createElement('span');
                aiName.className = "text-xs font-semibold text-pink-500";
                aiName.textContent = "‡¶∏‡ßã‡¶®‡¶æ‡¶≤‡¶ø";
                aiInfoDiv.appendChild(aiName);
                
                bubbleDiv.appendChild(aiInfoDiv);
            }
            
            // Add image if present
            if (imageUrl) {
                const imgDiv = document.createElement('div');
                imgDiv.className = "mb-2";
                
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = "Attached image";
                img.className = "rounded-lg max-h-48 w-full object-cover border border-pink-100";
                
                imgDiv.appendChild(img);
                bubbleDiv.appendChild(imgDiv);
            }
            
            // Add message text
            const textDiv = document.createElement('p');
            textDiv.className = "text-sm whitespace-pre-wrap";
            textDiv.textContent = text;
            bubbleDiv.appendChild(textDiv);
            
            messageDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Refresh icons
            lucide.createIcons();
        }
        
        function toggleLoading(show) {
            if (show) {
                loadingModal.classList.remove('hidden');
                sendBtn.disabled = true;
                messageInput.disabled = true;
            } else {
                loadingModal.classList.add('hidden');
                sendBtn.disabled = false;
                messageInput.disabled = false;
            }
        }
        
        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = (error) => reject(error);
            });
        }
        
        function formatDate(date) {
            if (!date) return '';
            
            const now = new Date();
            const diffInHours = (now - date) / (1000 * 60 * 60);
            
            if (diffInHours < 24) {
                return date.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('bn-BD', { month: 'short', day: 'numeric' });
            }
        }
        
        async function loadAdminData() {
            if (!isAdmin) return;
            
            toggleLoading(true);
            
            try {
                // Get active users count (users who signed in last 30 days)
                const activeUsersQuery = await db.collection('users')
                    .where('lastLogin', '>=', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000))
                    .get();
                
                activeUsersCount.textContent = activeUsersQuery.size;
                
                // Get today's chats count
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const todayChatsQuery = await db.collectionGroup('chats')
                    .where('updatedAt', '>=', today)
                    .get();
                
                todayChatsCount.textContent = todayChatsQuery.size;
                
                // Get total chats count
                const totalChatsQuery = await db.collectionGroup('chats').get();
                totalChatsCount.textContent = totalChatsQuery.size;
                
                // Get user logs
                const usersQuery = await db.collection('users').orderBy('lastLogin', 'desc').get();
                
                userLogTable.innerHTML = '';
                
                usersQuery.forEach((doc) => {
                    const user = doc.data();
                    const row = document.createElement('tr');
                    
                    // Count user's chats
                    const chatCount = user.chatCount || 0;
                    
                    row.innerHTML = `
                        <td class="px-4 py-2 text-sm">${user.displayName || '‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ'}</td>
                        <td class="px-4 py-2 text-sm">${user.email || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm">${user.lastLogin ? formatAdminDate(user.lastLogin.toDate()) : '‡¶ï‡¶ñ‡¶®‡ßã ‡¶®‡¶æ'}</td>
                        <td class="px-4 py-2 text-sm">${chatCount}</td>
                        <td class="px-4 py-2 text-sm">
                            <button class="text-red-500 hover:text-red-700 delete-user" data-uid="${doc.id}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    
                    userLogTable.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-user').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const userId = e.target.closest('button').getAttribute('data-uid');
                        deleteUser(userId);
                    });
                });
                
                // Refresh icons
                lucide.createIcons();
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            } finally {
                toggleLoading(false);
            }
        }
        
        function formatAdminDate(date) {
            if (!date) return '';
            return date.toLocaleString('bn-BD');
        }
        
        async function deleteUser(userId) {
            if (!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡•§')) {
                return;
            }
            
            toggleLoading(true);
            
            try {
                // Delete user's chats
                const chatsQuery = await db.collection('users').doc(userId).collection('chats').get();
                const batch = db.batch();
                
                chatsQuery.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Delete user document
                await db.collection('users').doc(userId).delete();
                
                // Refresh admin data
                loadAdminData();
                
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
            } finally {
                toggleLoading(false);
            }
        }
    </script>
</body>
</html>
